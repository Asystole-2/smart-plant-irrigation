{% extends "layout.html" %}
{% block body %}
<div class="liquid-bg">
    <div class="liquid-blob blob-blue-1"></div>
    <div class="liquid-blob blob-blue-2"></div>
    <div class="liquid-blob blob-green-1"></div>
    <div class="liquid-blob blob-green-2"></div>
    <div class="liquid-blob blob-green-3"></div>
    <div class="liquid-blob blob-purple-1"></div>
    <div class="liquid-blob blob-purple-2"></div>
    <div class="liquid-blob blob-accent"></div>
</div>

<div class="mt-8 relative z-10 px-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-black tracking-tighter text-white">My Garden</h1>
    </div>

    <div class="garden-grid pb-10">
        {% for plant in plants %}
        <div class="plant-card group relative"
             data-card-id="{{ plant.id }}"
     onclick="openPlantDetail({{ plant.id }}, '{{ plant.name }}', '{{ plant.location or 'Lab' }}', '{{ plant.last_moisture or 0 }}', '{{ url_for('static', filename='uploads/' + (plant.image_url or 'default_plant.png')) }}', {{ plant.moisture_threshold or 30 }})">


            <div class="relative overflow-hidden h-48 bg-white/5 flex items-center justify-center">
                <i class="fas fa-leaf text-blue-500/20 text-4xl absolute z-0"></i>
                <img src="{{ url_for('static', filename='uploads/' + (plant.image_url or 'default_plant.png')) }}"
                     class="plant-img relative z-10 transition-transform duration-700 group-hover:scale-110"
                     onerror="this.style.display='none'">
                <div class="absolute inset-0 z-20 bg-gradient-to-t from-[#020617] to-transparent opacity-60"></div>
                <div class="absolute top-4 right-4 z-30 status-pill bg-black/40 backdrop-blur-md border-white/10">
                    <i class="fas fa-map-marker-alt text-[10px] mr-1"></i>
                    <span class="text-[9px] uppercase tracking-widest">{{ plant.location or 'Lab' }}</span>
                </div>
            </div>

            <div class="p-6">
                <h3 class="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">{{ plant.name }}</h3>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1 mb-4">
                    Last Sync: {{ plant.last_update.strftime('%H:%M') if plant.last_update else 'N/A' }}
                </p>
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-[11px] font-bold uppercase tracking-widest">
                        <span class="text-gray-400">Moisture</span>
                        <span class="text-blue-400">{{ plant.last_moisture or 0 }}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden border border-white/5">
                        <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_10px_#3b82f6] transition-all duration-1000"
                             style="width: {{ plant.last_moisture or 0 }}%"></div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/5 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-2 group-hover:translate-y-0">
                    <div class="flex justify-between items-center">
                        <span id="threshold-display-{{ plant.id }}" class="text-[9px] text-gray-500 uppercase tracking-tighter">
                    Threshold: {{ plant.moisture_threshold }}%
                </span>
                <i class="fas fa-chevron-right text-blue-500 text-xs"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% include "components/plant_modal.html" %}

<script>
let currentPlantId = null;
let pumpActive = false;

// Syncs Slider and Number input locally
function syncThresholdUI() {
    const slider = document.getElementById('threshold-slider');
    const num = document.getElementById('threshold-num');

    slider.oninput = (e) => { num.value = e.target.value; };
    num.oninput = (e) => { slider.value = e.target.value; };
}


async function saveThresholdToDB() {
    if (!currentPlantId) return;

    const val = document.getElementById('threshold-slider').value;
    const btn = document.getElementById('save-threshold-btn');
    const originalIcon = btn.innerHTML;

    try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const response = await fetch(`/update-threshold/${currentPlantId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ threshold: parseInt(val) })
        });

        const result = await response.json();

        if (response.ok) {
            btn.innerHTML = '<i class="fas fa-check-double text-white"></i>';
            btn.classList.add('bg-emerald-600');

            // 1. Update the Text Display on the Card
            const displaySpan = document.getElementById(`threshold-display-${currentPlantId}`);
            if (displaySpan) {
                displaySpan.innerText = `Threshold: ${val}%`;
            }

            // 2. Update the 'onclick' attribute so if the modal is reopened,
            // it has the new threshold value immediately.
            const card = document.querySelector(`[data-card-id="${currentPlantId}"]`);
            if (card) {
                const currentOnClick = card.getAttribute('onclick');
                // Regex to replace the last numeric argument (threshold)
                const newOnClick = currentOnClick.replace(/, \d+\)$/, `, ${val})`);
                card.setAttribute('onclick', newOnClick);
            }

            setTimeout(() => {
                btn.innerHTML = originalIcon;
                btn.classList.remove('bg-emerald-600');
            }, 2000);
        } else {
            alert("Error: " + (result.message || "Unauthorized"));
            btn.innerHTML = originalIcon;
        }
    } catch (err) {
        console.error("Save failed:", err);
        btn.innerHTML = originalIcon;
    }
}
async function openPlantDetail(id, name, location, moisture, img, threshold) {
    currentPlantId = id;
    const modal = document.getElementById('plant-modal');
    const modalImg = document.getElementById('modal-img');
    const fallback = document.getElementById('modal-img-fallback');

    // Threshold Setup
     const slider = document.getElementById('threshold-slider');
    const num = document.getElementById('threshold-num');
    slider.value = threshold;
    num.value = threshold;

    // Call sync function after setting values
    setTimeout(() => syncThresholdUI(), 100);

    // UI population
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('modal-title').innerText = name;
    document.getElementById('modal-location').innerText = location;
    document.getElementById('modal-moisture').innerText = moisture + '%';
    document.getElementById('modal-photo-form').action = `/update-plant-photo/${id}`;

    // Image logic
    fallback.classList.add('hidden');
    modalImg.classList.remove('hidden');
    modalImg.src = img;

    // AI logic
    document.querySelectorAll('.ai-content-compact').forEach(p => p.innerText = "Synthesizing data...");
    try {
        const response = await fetch(`/api/ai-tips/${id}`);
        const data = await response.json();
        document.getElementById('ai-watering').innerText = data.watering || "No data.";
        document.getElementById('ai-lighting').innerText = data.lighting || "No data.";
        document.getElementById('ai-fertilization').innerText = data.fertilization || "No data.";
        document.getElementById('ai-other').innerText = data.other || "No data.";
    } catch (err) {
        document.querySelectorAll('.ai-content-compact').forEach(p => p.innerText = "Offline.");
    }
}

function togglePump() {
    const btn = document.getElementById('pump-control-btn');
    pumpActive = !pumpActive;
    if (pumpActive) {
        btn.innerHTML = '<i class="fas fa-stop mr-2"></i> Stop Pump';
        btn.className = "flex-[2] py-4 bg-red-600 hover:bg-red-500 text-white rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-red-900/40";
    } else {
        btn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Pump';
        btn.className = "flex-[2] py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-blue-900/40";
    }
}

function confirmDeletion(type) {
    const confirmModal = document.getElementById('confirm-modal');
    const actionBtn = document.getElementById('confirm-action-btn');
    confirmModal.classList.remove('hidden');

    const submitPost = (url) => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        document.body.appendChild(form);
        form.submit();
    };

    if (type === 'photo') {
        document.getElementById('confirm-title').innerText = "Remove Photo?";
        actionBtn.onclick = () => submitPost(`/remove-plant-photo/${currentPlantId}`);
    } else {
        document.getElementById('confirm-title').innerText = "Delete Plant?";
        actionBtn.onclick = () => submitPost(`/delete-plant/${currentPlantId}`);
    }
}

function handleImgError() {
    document.getElementById('modal-img').classList.add('hidden');
    document.getElementById('modal-img-fallback').classList.remove('hidden');
}

function closeModal() { document.getElementById('plant-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden'); }

function toggleAccordion(btn) {
    const panel = btn.nextElementSibling;
    const icon = btn.querySelector('.fa-plus');
    const isOpen = panel.classList.contains('open');
    document.querySelectorAll('.accordion-panel').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.fa-plus').forEach(i => i.style.transform = "rotate(0deg)");
    if (!isOpen) { panel.classList.add('open'); icon.style.transform = "rotate(45deg)"; }
}
</script>
{% endblock %}